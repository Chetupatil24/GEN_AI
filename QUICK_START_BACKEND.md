# üéØ Backend Integration - Quick Start

This is a quick reference for integrating the Pet Roast AI Service with your Railway backend.

## üöÄ Quick Setup (5 Minutes)

### Step 1: Configure AI Service

```bash
# In your AI service repository
./setup_backend.sh
```

Enter when prompted:
- **Revid API Key**: Your Revid.ai API key
- **Backend Webhook URL**: `https://your-backend.railway.app/webhooks/pet-roast-complete`
- **Backend CORS URL**: `https://your-backend.railway.app`
- **Redis URL**: (Leave empty to use Railway addon)

### Step 2: Deploy AI Service to Railway

```bash
git add .
git commit -m "Configure backend integration"
git push origin main

# Deploy to Railway
railway up

# Add Redis addon in Railway dashboard
# Go to your project ‚Üí Add Service ‚Üí Redis
```

### Step 3: Implement Backend Webhook

Add this endpoint to your backend:

```typescript
// POST /webhooks/pet-roast-complete
app.post('/webhooks/pet-roast-complete', async (req, res) => {
  const { job_id, status, video_url, error } = req.body;

  // Update job in database
  await db.roastJobs.update(
    { jobId: job_id },
    { status, videoUrl: video_url, error }
  );

  // Send push notification if completed
  if (status === 'completed' && video_url) {
    await sendPushNotification(userId, {
      title: 'üé¨ Your Pet Roast is Ready!',
      body: 'Watch your hilarious pet roast now!',
      data: { videoUrl: video_url }
    });
  }

  res.json({ status: 'success' });
});
```

### Step 4: Call AI Service from Backend

```typescript
// Generate video mutation/resolver
async function generateRoast(petId: string, text: string, imageUrl: string) {
  // Call AI service
  const response = await fetch(`${AI_SERVICE_URL}/api/generate-video`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text, image_url: imageUrl })
  });

  const { job_id } = await response.json();

  // Store in database
  await db.roastJobs.create({
    jobId: job_id,
    petId,
    text,
    imageUrl,
    status: 'queued'
  });

  return job_id;
}
```

### Step 5: Test Integration

```bash
# Test AI service health
curl https://your-ai-service.railway.app/healthz

# Test backend connectivity
curl https://your-ai-service.railway.app/api/test-backend-connection

# Run full integration tests
python test_integration.py \
  --ai-service-url https://your-ai-service.railway.app \
  --backend-url https://your-backend.railway.app
```

---

## üì° API Endpoints

### Backend ‚Üí AI Service

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/generate-video` | POST | Start video generation |
| `/api/video-status/{job_id}` | GET | Check video status |
| `/api/test-backend-connection` | GET | Test webhook connectivity |
| `/healthz` | GET | Health check |

### AI Service ‚Üí Backend

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/webhooks/pet-roast-complete` | POST | Video completion webhook |

---

## üîÑ Integration Flow

```
User Uploads Pet Image
        ‚Üì
Backend receives image
        ‚Üì
Backend calls AI Service: POST /api/generate-video
        ‚Üì
AI Service validates pets (YOLOv5)
        ‚Üì
AI Service returns job_id (202 Accepted)
        ‚Üì
Backend stores job_id in database
        ‚Üì
Backend returns success to user
        ‚Üì
[Background: Video being generated by Revid.ai]
        ‚Üì
AI Service receives completion from Revid
        ‚Üì
AI Service webhooks Backend: POST /webhooks/pet-roast-complete
        ‚Üì
Backend updates database
        ‚Üì
Backend sends push notification
        ‚Üì
User sees "Video Ready!" üé¨
```

---

## ‚öôÔ∏è Environment Variables

### AI Service (.env)

```env
REVID_API_KEY=your_revid_api_key
BACKEND_WEBHOOK_URL=https://your-backend.railway.app/webhooks/pet-roast-complete
CORS_ORIGINS=["https://your-backend.railway.app"]
REDIS_URL=redis://default:password@redis.railway.internal:6379
USE_REDIS=true
```

### Backend (.env)

```env
AI_SERVICE_URL=https://your-ai-service.railway.app
```

---

## üêõ Troubleshooting

### No Pets Detected

**Error:**
```json
{
  "detail": {
    "error": "no_pets_detected",
    "message": "No pets found in the uploaded image..."
  }
}
```

**Solution:** Ensure image contains clear, visible pets. Supported: dog, cat, bird, horse, etc.

### Backend Not Receiving Webhook

**Check:**
1. `BACKEND_WEBHOOK_URL` is set correctly in AI service
2. Backend endpoint `/webhooks/pet-roast-complete` exists and is accessible
3. Check AI service logs: `railway logs --service ai-service`

**Test webhook manually:**
```bash
curl -X POST https://your-backend.railway.app/webhooks/pet-roast-complete \
  -H "Content-Type: application/json" \
  -d '{
    "job_id": "test",
    "status": "completed",
    "video_url": "https://example.com/video.mp4"
  }'
```

### Video Generation Timeout

**Cause:** Revid.ai takes longer than expected

**Solution:** Videos typically take 30-90 seconds. Use webhook instead of polling.

---

## ‚úÖ Checklist

### AI Service Setup
- [ ] Deploy AI service to Railway
- [ ] Add Redis addon
- [ ] Set `REVID_API_KEY`
- [ ] Set `BACKEND_WEBHOOK_URL`
- [ ] Set `CORS_ORIGINS`
- [ ] Test health: `curl {ai-url}/healthz`

### Backend Setup
- [ ] Set `AI_SERVICE_URL` environment variable
- [ ] Implement webhook endpoint `/webhooks/pet-roast-complete`
- [ ] Implement video generation function
- [ ] Add error handling for no pets
- [ ] Implement push notifications
- [ ] Test webhook manually

### Testing
- [ ] Test backend connectivity: `GET /api/test-backend-connection`
- [ ] Generate test video with pet image
- [ ] Verify webhook received by backend
- [ ] Check push notification sent
- [ ] Test no pets error handling
- [ ] Run integration test suite

---

## üìö Full Documentation

- **[BACKEND_INTEGRATION.md](BACKEND_INTEGRATION.md)** - Complete integration guide with code examples
- **[API_REFERENCE.md](API_REFERENCE.md)** - Detailed API documentation
- **[RAILWAY_DEPLOYMENT.md](RAILWAY_DEPLOYMENT.md)** - Railway deployment guide
- **[README.md](README.md)** - Project overview

---

## üÜò Need Help?

1. Check logs: `railway logs`
2. Test connectivity: `curl {ai-url}/api/test-backend-connection`
3. Run tests: `python test_integration.py`
4. Review [BACKEND_INTEGRATION.md](BACKEND_INTEGRATION.md) for detailed examples

---

**Ready to integrate?** Start with `./setup_backend.sh` üöÄ
